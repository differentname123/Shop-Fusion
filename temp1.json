const updateDatabase = async (db, combinedData) => {
  if (!combinedData.goodsId || !combinedData.groupOrderId) {
    console.error('goodsId 或 groupOrderId 不能为空，数据未插入数据库。');
    return {
      status: 'error',
      message: 'goodsId 或 groupOrderId 不能为空，数据未插入数据库。',
      data: combinedData,
    };
  }

  try {
    console.log(
      `开始查询是否存在 goodsId=${combinedData.goodsId} 和 groupOrderId=${combinedData.groupOrderId} 的记录`
    );

    // 查询是否存在相同 goodsId 和 groupOrderId 的记录
    const existingRecords = await db
      .collection('groupGoodsInfo')
      .where({
        goodsId: combinedData.goodsId,
        groupOrderId: combinedData.groupOrderId,
      })
      .get();

    console.log(`查询结果：找到 ${existingRecords.data.length} 条记录`);

    if (existingRecords.data.length > 0) {
      // 如果记录已存在，更新该记录
      const existingRecord = existingRecords.data[0];
      console.log(`找到记录，记录 ID: ${existingRecord._id}，准备更新`);

      await db.collection('groupGoodsInfo').doc(existingRecord._id).update({
        data: {
          ...combinedData,
          display: existingRecord.display, // 保留原来的 display 值
        },
      });

      console.log(`记录更新成功，goodsId=${combinedData.goodsId}, groupOrderId=${combinedData.groupOrderId}`);
      return {
        status: 'success',
        message: '记录已成功更新。',
        data: combinedData,
        points: 0,
      };
    } else {
      // 如果记录不存在，插入新记录
      console.log(`未找到匹配记录，准备插入新记录：goodsId=${combinedData.goodsId}, groupOrderId=${combinedData.groupOrderId}`);

      const addRes = await db.collection('groupGoodsInfo').add({
        data: combinedData,
      });

      console.log(`插入新记录成功，记录 ID：${addRes._id}`);
      return {
        status: 'success',
        message: '新记录已成功插入。',
        data: combinedData,
        points: 0,
      };
    }
  } catch (error) {
    console.error('数据库操作时发生错误：', error);
    throw new Error('数据库操作时发生错误。');
  }
};